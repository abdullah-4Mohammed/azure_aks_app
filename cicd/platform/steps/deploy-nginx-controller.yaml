parameters:
  - name: environment
    type: string
  - name: location
    type: string
  - name: resourceGroupName
    type: string
  - name: clusterName
    type: string
  - name: kubernetesVersion
    type: string
  - name: systemNodeCount
    type: number
  - name: acrName
    type: string
  - name: workingDirectory
    type: string
  - name: backendType
    type: string
  - name: backendServiceArmConnection
    type: string
  - name: backendAzureRmResourceGroupName
    type: string
  - name: backendAzureRmStorageAccountName
    type: string
  - name: backendAzureRmContainerName
    type: string
  - name: backendAzureRmKey
    type: string

steps:
  # Install Helm
  - task: HelmInstaller@0
    displayName: 'Install Helm'
    inputs:
      helmVersion: '3.x'
  # Connect to AKS
  - task: AzureCLI@2
    displayName: 'Connect to AKS'
    inputs:
      azureSubscription: ${{ parameters.backendServiceArmConnection }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        az aks get-credentials --name ${{parameters.clusterName}}  --resource-group ${{parameters.resourceGroupName}} --admin
  
  # - script: |
  #     helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
  #     helm repo update
  #     helm upgrade ingress-nginx ingress-nginx/ingress-nginx --create-namespace -n ingress-nginx --install --set controller.service.externalTrafficPolicy=Local
  #   displayName: 'Deploy NGINX Ingress Controller'

  - script: |
      set -x
      kubectl apply -f $(System.DefaultWorkingDirectory)/deploy/infrastructure/ingress/${{parameters.environment}}-frontend-ingress.yaml
    displayName: 'Apply Ingress deployment'
